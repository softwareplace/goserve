#!/bin/bash

set -e

echo

mkdir -p .out || true

cov_ignoring=()

function appendCoverageIgnoring() {
  local ignoring_value="$1"

  # Ignoring values that starts with #, considered as a comment
  if [[ ! "$ignoring_value" =~ ^# ]]; then
    cov_ignoring+=("$ignoring_value")
  fi
}

if [ -f .covignore ]; then
  while ifs= read -r i; do appendCoverageIgnoring "${i%?}"; done < .covignore
fi

if [ ${#cov_ignoring[@]} -ne 0 ]; then
  printf "Coverage ignoring:\n"
  printf "  %s\n" "${cov_ignoring[@]}"
  echo
fi

function runCoverage() {
  go test ./... -coverprofile=.out/coverage.out
  coverage_out=$(cat .out/coverage.out)

  for i in "${cov_ignoring[@]}" ; do
      coverage_out=$(echo "$coverage_out" | grep -v "$i")
  done

  echo "$coverage_out" > .out/coverage.out
  gocov convert .out/coverage.out > .out/coverage.json
  cat .out/coverage.json | gocov-html > .out/index.html

  # Extract total coverage percentage
  TOTAL_COVERAGE=$(cat .out/index.html | grep 'id="totalcov"' | sed -E 's/.*>([0-9.]+%).*/\1/')

  # Check if coverage meets minimum requirement
  MIN_COVERAGE=40
  if (( $(echo "$TOTAL_COVERAGE < $MIN_COVERAGE" | bc -l) )); then
      echo -e "\033[0;31mTotal Coverage: $TOTAL_COVERAGE%\033[0m"
      echo -e "\033[0;31m❌ Coverage is below minimum required ($MIN_COVERAGE%)\033[0m"
      exit 1
  else
      echo -e "\033[0;32mTotal Coverage: $TOTAL_COVERAGE%\033[0m"
      echo -e "\033[0;32m✅ Coverage meets minimum requirement ($MIN_COVERAGE%)\033[0m"
  fi
}

runCoverage